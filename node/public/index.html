<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Stock Analyzer - 예측 리스트</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>AI Stock Analyzer 예측 리스트<span id="envBadge" class="badge">상태 확인 중...</span></h1>
      <div class="toolbar">
        <input id="q" type="text" placeholder="종목코드/이름 검색(예: 005930, 삼성전자)">
        <select id="market">
          <option value="ALL">전체시장</option>
          <option value="KOSPI">KOSPI</option>
          <option value="KOSDAQ">KOSDAQ</option>
        </select>
        <select id="sector">
          <option value="ALL">전체분야</option>
        </select>
        <div class="nav-tabs">
          <button id="recoBtn" class="nav-tab">추천종목</button>
          <button id="holdingsBtn" class="nav-tab">보유종목</button>
          <button id="tradeHistoryBtn" class="nav-tab">매매 기록</button>
          <button id="alertToggleBtn" class="nav-tab">알림 숨기기</button>
        </div>
      </div>
    </header>
    <div id="marketAlert" class="market-alert hidden"></div>

    <div class="panel table-panel">
      <table class="stock-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="rank">순위</th>
            <th class="sortable" data-sort="market">구분(분야)</th>
            <th class="sortable" data-sort="name">종목/코드</th>
            <th class="right sortable" data-sort="close">현재가</th>
            <th class="right sortable" data-sort="ret">3개월 수익률</th>
            <th class="right sortable" data-sort="pred60">예측수익률(60d)</th>
            <th class="right sortable" data-sort="pred90">예측수익률(90d)</th>
            <th class="right sortable" data-sort="mdd60">예상 MDD(60d)</th>
            <th class="sortable score-col" data-sort="score">
              <span class="tooltip" title="R(수익): 모멘텀/수익률&#10;P(확률): Top20 포함&#10;Q(퀄리티): 실적/기초체력&#10;T(기술): 기술적 지표&#10;M(모델): 예측 수익률&#10;RP(리스크): 변동성 패널티&#10;길이 비중으로 스코어 표시">지표·스코어</span>
            </th>
            <th>액션</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- 반복: rows 데이터를 데스크톱 테이블 행으로 렌더링 -->
          <tr><td colspan="10" class="center">표시할 데이터가 없습니다.</td></tr>
        </tbody>
      </table>
      <div class="status" id="status"></div>
    </div>
    <div class="mobile-list" id="mobileList">
      <!-- 반복: rows 데이터를 모바일 카드(.stock-card)로 렌더링 -->
    </div>
  </div>

  <!-- Trade modal -->
  <div class="overlay" id="tradeOverlay">
    <div class="trade-modal">
      <div class="trade-modal-header">
        <div class="trade-modal-title" id="tradeModalTitle">매수 입력</div>
        <button class="modal-close" onclick="closeTradeModal()">닫기</button>
      </div>
      <div class="trade-field">
        <div class="trade-label" id="tradeInfo"></div>
      </div>
      <div class="trade-field">
        <div class="trade-label">날짜</div>
        <input id="tradeDate" type="date" class="trade-input">
      </div>
      <div class="trade-field">
        <div class="trade-label">수량</div>
        <input id="tradeQty" type="number" class="trade-input" min="1">
      </div>
      <div class="trade-field">
        <div class="trade-label">가격</div>
        <input id="tradePrice" type="number" class="trade-input" min="1">
      </div>
      <div class="trade-actions">
        <button onclick="saveTrade()">저장</button>
        <button onclick="closeTradeModal()">취소</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : null; };
    const API_BASE = window.__API_BASE__ || "";
    const api = (path) => `${API_BASE}${path}`;
    let universe = [];
    let rankMap = new Map();
    const sortState = { key: "score", dir: "desc" };
    let alertHidden = false;
    let tradeCtx = { side:"BUY", code:"", name:"" };

    const fmtPct = (v, digits = 2) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return "-";
      return (n * 100).toFixed(digits) + "%";
    };
    const getRiskClass = (mdd) => {
      if (!Number.isFinite(mdd)) return "";
      if (mdd <= -0.3) return "neg";
      if (mdd <= -0.15) return "warn";
      return "pos";
    };

    function buildRank(rows) {
      const arr = rows.filter(r => Number.isFinite(+r.final_score) || Number.isFinite(+r.score))
        .sort((a,b)=>{
          const af = Number.isFinite(+a.final_score)?+a.final_score:(Number.isFinite(+a.score)?+a.score:-Infinity);
          const bf = Number.isFinite(+b.final_score)?+b.final_score:(Number.isFinite(+b.score)?+b.score:-Infinity);
          return bf-af;
        });
      rankMap = new Map();
      arr.forEach((r,i)=>rankMap.set(r.code, i+1));
    }

    function applySort(rows){
      const {key,dir}=sortState;
      const g=(r)=>{
        switch(key){
          case "name": return (r.name||"").toLowerCase();
          case "code": return (r.code||"").toLowerCase();
          case "market": return (r.market||"").toLowerCase();
          case "close": return toNum(r.close) ?? -Infinity;
          case "ret": return toNum(r.ret_3m) ?? -Infinity;
          case "pred60": return toNum(r.pred_return_60d) ?? -Infinity;
          case "pred90": return toNum(r.pred_return_90d) ?? -Infinity;
          case "mdd60": return toNum(r.pred_mdd_60d) !== null ? -toNum(r.pred_mdd_60d) : -Infinity;
          case "rank": return rankMap.get(r.code) ?? Infinity;
          case "score":
          default:
            return Number.isFinite(+r.final_score)?+r.final_score:(Number.isFinite(+r.score)?+r.score:-Infinity);
        }
      };
      return rows.sort((a,b)=>{
        const va=g(a), vb=g(b);
        if(va<vb) return dir==="asc"?-1:1;
        if(va>vb) return dir==="asc"?1:-1;
        return 0;
      });
    }

    function buildStrip(r){
      const R = toNum(r.ret_score)||0;
      const P = toNum(r.prob_score)||0;
      const Q = toNum(r.qual_score)||0;
      const T = toNum(r.tech_score)||0;
      const M = toNum(r.pred_score)||0;
      const RP= toNum(r.risk_penalty)||0;
      let total = R+P+Q+T+M+RP;
      if(!Number.isFinite(total) || total<=0) total=1;
      const minPct=0.5;
      const seg=(val,cls,label,desc)=>{
        const pct=Math.max((val/total)*100,minPct);
        const tooltip = `${label}: ${val.toFixed(1)}점\n${desc}`;
        return `<div class="seg ${cls}" style="flex-basis:${pct}%" title="${tooltip}"></div>`;
      };
      return `
        <div class="score-cell">
          <span class="score-val">${Number.isFinite(+r.final_score)?(+r.final_score).toFixed(1)+'점':'-'}</span>
          <div class="score-strip">
            ${seg(R,'seg-R','R (Return Score)','최근 모멘텀/수익률 기반')}
            ${seg(P,'seg-P','P (Probability Score)','모델의 예측 상위 Top20 포함')}
            ${seg(Q,'seg-Q','Q (Quality Score)','실적/기초체력 지표')}
            ${seg(T,'seg-T','T (Tech Score)','기술적 지표 기반')}
            ${seg(M,'seg-M','M (Model Score)','예측 수익률 기반')}
            ${seg(RP,'seg-RP','RP (Risk Penalty)','변동성 및 리스크 패널티')}
          </div>
        </div>`;
    }

    function render(){
      const q = (($("#q")?.value)||"").trim().toLowerCase();
      let rows = universe.slice();
      const mktFilter = (($("#market")?.value)||"ALL").toUpperCase();
      const sectorFilter = (($("#sector")?.value)||"ALL");
      const mobileList = $("#mobileList");
      const isMobile = window.matchMedia("(max-width: 768px)")?.matches === true;
      if(mktFilter!=="ALL") rows = rows.filter(r => (r.market||"").toUpperCase()===mktFilter);
      if(sectorFilter!=="ALL") rows = rows.filter(r => (r.sector||"")===sectorFilter);
      if(q) rows = rows.filter(r => (r.code||"").toLowerCase().includes(q) || (r.name||"").toLowerCase().includes(q));
      if(!rows.length){
        $("#tbody").innerHTML='<tr><td colspan="10" class="center">표시할 데이터가 없습니다.</td></tr>';
        if(mobileList && isMobile) mobileList.innerHTML='<div class="stock-card"><div class="stock-card-sub">표시할 데이터가 없습니다.</div></div>';
        if(mobileList && !isMobile) mobileList.innerHTML="";
        return;
      }
      rows = applySort(rows);
      const html = rows.map(r=>{
        const pred60=toNum(r.pred_return_60d); const pred90=toNum(r.pred_return_90d);
        const ret3 = toNum(r.ret_3m); const mdd=toNum(r.pred_mdd_60d);
        const link = `./detail.html?code=${encodeURIComponent(r.code)}`;
        const strip = buildStrip(r);
        return `
          <tr onclick="location.href='${link}'" style="cursor:pointer">
            <td class="rank">${rankMap.get(r.code)??"-"}</td>
            <td><div class="cell-market">${(r.market||"").toUpperCase()} <span class="sector">(${r.sector||"-"})</span></div></td>
            <td><div class="cell-name"><div class="name">${r.name||r.code}</div><div class="code">${r.code}</div></div></td>
            <td class="right">${Number.isFinite(+r.close)?Number(r.close).toLocaleString():"-"}</td>
            <td class="right ${ret3>=0?'pos':'neg'}">${fmtPct(ret3)}</td>
            <td class="right ${pred60>=0?'pos':'neg'}">${fmtPct(pred60)}</td>
            <td class="right ${pred90>=0?'pos':'neg'}">${fmtPct(pred90)}</td>
            <td class="right">${Number.isFinite(mdd)?`<span class="pill ${getRiskClass(mdd)}">${(mdd*100).toFixed(2)}%</span>`:"-"}</td>
            <td class="right">${strip}</td>
            <td>
              <button onclick="openTradeModal('BUY','${r.code}','${r.name||r.code}', event)">매수</button>
              <button onclick="openTradeModal('SELL','${r.code}','${r.name||r.code}', event)">매도</button>
            </td>
          </tr>`;
      }).join("");
      const mobileHtml = !isMobile ? "" : rows.map(r=>{
        const link = `./detail.html?code=${encodeURIComponent(r.code)}`;
        const pred60=toNum(r.pred_return_60d); const pred90=toNum(r.pred_return_90d);
        const ret3 = toNum(r.ret_3m); const mdd=toNum(r.pred_mdd_60d);
        const close = Number.isFinite(+r.close)?Number(r.close).toLocaleString():"-";
        const strip = buildStrip(r);
        return `
          <article class="stock-card" onclick="location.href='${link}'">
            <div class="stock-card-header">
              <span class="rank-badge">${rankMap.get(r.code)??"-"}위</span>
              <span class="market-tag">${(r.market||"").toUpperCase()}</span>
            </div>
            <div class="stock-name">${r.name||r.code}</div>
            <div class="stock-code">${r.code}</div>
            <div class="stock-card-sub">${r.sector||"-"}</div>
            <div class="card-metrics">
              <div class="metric">
                <div class="metric-label">현재가</div>
                <div class="metric-val">${close}</div>
              </div>
              <div class="metric">
                <div class="metric-label">3개월 수익률</div>
                <div class="metric-val ${ret3>=0?'pos':'neg'}">${fmtPct(ret3)}</div>
              </div>
              <div class="metric">
                <div class="metric-label">예측(60d)</div>
                <div class="metric-val ${pred60>=0?'pos':'neg'}">${fmtPct(pred60)}</div>
              </div>
              <div class="metric">
                <div class="metric-label">예측(90d)</div>
                <div class="metric-val ${pred90>=0?'pos':'neg'}">${fmtPct(pred90)}</div>
              </div>
              <div class="metric">
                <div class="metric-label">예상 MDD</div>
                <div class="metric-val">${Number.isFinite(mdd)?`<span class="pill ${getRiskClass(mdd)}">${(mdd*100).toFixed(2)}%</span>`:"-"}</div>
              </div>
              <div class="metric">
                <div class="metric-label">종합 스코어</div>
                <div class="score-mini">${strip}</div>
              </div>
            </div>
          </article>`;
      }).join("");
      $("#tbody").innerHTML = html;
      if(mobileList) mobileList.innerHTML = mobileHtml;
    }

    async function fetchEnv(){
      try{
        const res=await fetch(api("/api/health"));
        const info=await res.json();
        $("#envBadge").textContent = info?.status==="ok" ? (info.demo ? "DEMO":"LIVE") : "상태 불명";
      }catch{ $("#envBadge").textContent="상태 불명"; }
    }

    function populateSectors(rows){
      const select=$("#sector");
      const sectors=Array.from(new Set(rows.map(r=>r.sector||"").filter(Boolean))).sort((a,b)=>a.localeCompare(b,"ko"));
      select.innerHTML='<option value="ALL">전체분야</option>'+sectors.map(s=>`<option value="${s}">${s}</option>`).join("");
      select.onchange=render;
    }

    async function fetchRanking(){
      $("#status").textContent="불러오는 중...";
      try{
        const res=await fetch(api("/api/ranking"));
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        universe=Array.isArray(data)?data:(Array.isArray(data?.data)?data.data:[]);
        buildRank(universe);
        populateSectors(universe);
        render();
        $("#status").textContent=`총 ${universe.length}종목`;
      }catch(e){
        console.error(e);
        $("#status").textContent="불러오기 실패";
      }
    }

    function openTradeModal(side, code, name, e){
      if(e && e.stopPropagation) e.stopPropagation();
      tradeCtx = { side, code, name };
      const overlay=$("#tradeOverlay");
      const title=$("#tradeModalTitle");
      const info=$("#tradeInfo");
      const date=$("#tradeDate");
      const qty=$("#tradeQty");
      const price=$("#tradePrice");
      if(title) title.textContent = side==="BUY" ? "매수 입력" : "매도 입력";
      if(info) info.textContent = `${name} (${code})`;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      if(date) date.value = `${yyyy}-${mm}-${dd}`;
      if(qty) qty.value = "";
      if(price) price.value = "";
      if(overlay) overlay.style.display="flex";
    }
    function closeTradeModal(){
      const overlay=$("#tradeOverlay");
      if(overlay) overlay.style.display="none";
    }
    async function saveTrade(){
      const date = $("#tradeDate")?.value;
      const qty = Number($("#tradeQty")?.value);
      const price = Number($("#tradePrice")?.value);
      if(!date || !Number.isFinite(qty) || qty<=0 || !Number.isFinite(price) || price<=0){
        alert("날짜/수량/가격을 올바르게 입력해주세요");
        return;
      }
      const payload = { side: tradeCtx.side, code: tradeCtx.code, date, qty, price };
      try{
        const res = await fetch(api("/api/trades"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error("HTTP "+res.status);
        alert("저장되었습니다.");
        closeTradeModal();
      }catch(err){
        console.error(err);
        alert("저장 실패: "+err.message);
      }
    }

    function setAlertHidden(flag){
      alertHidden = flag;
      const box = $("#marketAlert");
      const btn = $("#alertToggleBtn");
      if(box) box.classList.toggle("hidden", flag);
      if(btn) btn.textContent = flag ? "알림 펼치기" : "알림 숨기기";
    }

    async function fetchMarketStatus(){
      const box=$("#marketAlert");
      if(!box) return;
      try{
        const res=await fetch(api("/api/market/status"));
        if(!res.ok) throw new Error("HTTP "+res.status);
        const m=await res.json();
        const isUp = m.market_up === true;
        const lines=[];
        const dateStr = m.status_date || "";
        if(dateStr) lines.push(`${dateStr} 기준`);
        if(Number.isFinite(m.kospi_close) && Number.isFinite(m.kospi_ma20)){
          lines.push(`KOSPI ${Number(m.kospi_close).toLocaleString()} / MA20 ${Number(m.kospi_ma20).toLocaleString()}`);
        }
        if(Number.isFinite(m.vol_5d)){
          lines.push(`5일변동성 ${(m.vol_5d*100).toFixed(2)}% (기준: 3% 미만)`);
        }
        if(Number.isFinite(m.foreign_5d)){
          lines.push(`최근 5일간 외국인 순매수 ${Number(m.foreign_5d).toLocaleString()}`);
        }
        const tag = isUp
          ? '<span class="tag good">위험 축소 국면</span>'
          : '<span class="tag bad">신중 매수 구간</span>';
        box.innerHTML = `${tag}<div class="lines">${lines.join("<br>")}</div>`;
        box.classList.toggle("hidden", alertHidden);
      }catch(e){
        console.warn("market status load fail", e);
        box.classList.add("hidden");
      }
    }

    (async function(){
      await fetchEnv();
      await fetchMarketStatus();
      await fetchRanking();
      setAlertHidden(false);
      $("#q")?.addEventListener("input", render);
      $("#market")?.addEventListener("change", render);
      $("#sector")?.addEventListener("change", render);
      document.querySelectorAll("th[data-sort]").forEach(th=>{
        th.addEventListener("click", ()=>{
          const key=th.dataset.sort;
          if(sortState.key===key) sortState.dir = sortState.dir==="asc"?"desc":"asc";
          else { sortState.key=key; sortState.dir="desc"; }
          render();
        });
      });
      $("#recoBtn")?.addEventListener("click", (e)=>{e.preventDefault(); window.location.href='./ranking.html';});
      $("#holdingsBtn")?.addEventListener("click", (e)=>{e.preventDefault(); window.location.href='./holdings.html';});
      $("#tradeHistoryBtn")?.addEventListener("click", (e)=>{e.preventDefault(); window.location.href='./trade-history.html';});
      $("#alertToggleBtn")?.addEventListener("click", (e)=>{e.preventDefault(); setAlertHidden(!alertHidden);});
      const path = (location.pathname||"").toLowerCase();
      const setActive = (id)=>{ document.querySelectorAll(".nav-tab").forEach(btn=>btn.classList.toggle("active", btn.id===id)); };
      if(path.includes("ranking")) setActive("recoBtn");
      else if(path.includes("holdings")) setActive("holdingsBtn");
      else if(path.includes("trade-history")) setActive("tradeHistoryBtn");
      else setActive("");
      const mq = window.matchMedia("(max-width: 768px)");
      if(mq?.addEventListener) mq.addEventListener("change", render);
      else if(mq?.addListener) mq.addListener(render);
    })();
  </script>
</body>
</html>
