<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Stock Analyzer - 예측 리스트</title>
  <style>
    :root {
      --bg: #020617;
      --panel: #020817;
      --panel-soft: #0b1020;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --danger: #e85c5c;
      --warn: #facc15;
      --border: #1e293b;
      --link: #60a5fa;
    }
    * { box-sizing: border-box; }
    body { margin:0; padding:0; background: radial-gradient(circle at top, #0b1120 0, #020617 55%); color:var(--text); font-family: "Noto Sans KR", system-ui, -apple-system, "Segoe UI", sans-serif; }
    a { color: var(--link); text-decoration: none; }
    .container { max-width: 1800px; margin: 0 auto; padding: 18px; }
    header { display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; }
    header h1 { margin:0; font-size:22px; display:flex; gap:8px; align-items:center; }
    .badge { padding:3px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input, select, button { padding:8px 10px; border-radius:6px; border:1px solid var(--border); background:#0b1020; color:var(--text); font-size:13px; }
    button { background:#1f2937; cursor:pointer; font-weight:500; }
    button:hover { background:#273549; }
    .panel { background: linear-gradient(135deg, var(--panel) 0, var(--panel-soft) 100%); border:1px solid #111827; border-radius:14px; overflow:hidden; box-shadow:0 18px 45px rgba(15,23,42,0.7); }
    table { width:100%; border-collapse:collapse; font-size:13px; min-width:1100px; }
    thead th { position:sticky; top:0; z-index:2; background:#020617; text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); color:var(--muted); font-weight:600; }
    th.sortable { cursor:pointer; }
    tbody td { padding:9px 12px; border-bottom:1px solid rgba(15,23,42,0.9); }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.55); }
    tbody tr:nth-child(even){ background: rgba(15,23,42,0.85); }
    tbody tr:hover { background:#1f2937; }
    .right { text-align:right; }
    .center { text-align:center; color: var(--muted); }
    .pos { color: #45b26b; }
    .neg { color: var(--danger); }
    .warn { color: var(--warn); }
    .pill { display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); font-size:12px; }
    .pill.pos { border-color:#45b26b; color:#45b26b; background:rgba(69,178,107,0.12); }
    .pill.neg { border-color:var(--danger); color:var(--danger); background:rgba(232,92,92,0.12); }
    .pill.warn{ border-color:var(--warn); color:var(--warn); background:rgba(250,204,21,0.12); }
    .score-cell { display:flex; flex-direction:column; gap:4px; min-width:220px; }
    .score-val { font-weight:600; font-size:13px; white-space:nowrap; }
    .score-strip { display:flex; height:6px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,0.08); }
    .seg { height:100%; }
    .seg-R { background:#2f81f7; }
    .seg-P { background:#14b8a6; }
    .seg-Q { background:#65c466; }
    .seg-T { background:#8b5cf6; }
    .seg-M { background:#38bdf8; }
    .seg-RP{ background:#f97373; }
    .cell-name .name { font-weight:600; }
    .cell-name .code { font-size:12px; opacity:0.7; }
    .cell-market .sector { font-size:12px; opacity:0.7; margin-left:4px; }
    th.score-col { text-align:center; }
    .status { color: var(--muted); font-size:12px; padding: 8px 12px; }
    /* Market alert ribbon */
    .market-alert { display:flex; align-items:flex-start; gap:10px; margin:12px 0 14px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0b1020; line-height:1.4; transition: opacity 0.2s ease, visibility 0.2s ease; }
    .market-alert.hidden { opacity:0; visibility:hidden; pointer-events:none; }
    .market-alert .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:600; flex-shrink:0; }
    .market-alert .tag.good { background:rgba(34,197,94,0.12); color:#4ade80; border:1px solid rgba(34,197,94,0.3); }
    .market-alert .tag.bad { background:rgba(248,113,113,0.12); color:#f87171; border:1px solid rgba(248,113,113,0.3); }
    .market-alert .lines { margin-top:2px; color:var(--muted); font-size:13px; }
    .toolbar .btn-sm { padding:6px 8px; }
    /* Overlay */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 30; }
    .modal { background:#0f172a; border:1px solid #1f2937; border-radius:12px; max-width:720px; width:90%; max-height:80vh; overflow:auto; box-shadow:0 16px 40px rgba(0,0,0,0.5); padding:18px; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .modal-body { font-size:13px; line-height:1.5; }
    .modal-close { border:1px solid var(--border); background:#1f2937; color:var(--text); padding:6px 10px; border-radius:6px; cursor:pointer; }
    .trade-modal { background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:16px; width:360px; max-width:90%; box-shadow:0 16px 40px rgba(0,0,0,0.5); }
    .trade-modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .trade-modal-title { font-weight:700; font-size:16px; }
    .trade-field { margin-bottom:10px; }
    .trade-label { font-size:12px; color: var(--muted); margin-bottom:4px; }
    .trade-input { width:100%; padding:8px 10px; border-radius:6px; border:1px solid var(--border); background:#0b1020; color:var(--text); }
    .trade-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>AI Stock Analyzer 예측 리스트 <span id="envBadge" class="badge">상태 확인 중...</span></h1>
      <div class="toolbar">
        <input id="q" type="text" placeholder="종목코드/이름 검색 (예: 005930, 삼성전자)">
        <select id="market">
          <option value="ALL">전체시장</option>
          <option value="KOSPI">KOSPI</option>
          <option value="KOSDAQ">KOSDAQ</option>
        </select>
        <select id="sector">
          <option value="ALL">전체분야</option>
        </select>
        <button id="recoBtn">추천종목</button>
        <button id="holdingsBtn">보유종목</button>
        <button id="tradeHistoryBtn" class="btn-sm">매매 이력</button>
        <button id="alertToggleBtn" class="btn-sm">알림 숨기기</button>
      </div>
    </header>
    <div id="marketAlert" class="market-alert hidden"></div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-sort="rank">순위</th>
            <th class="sortable" data-sort="market">구분(분야)</th>
            <th class="sortable" data-sort="name">종목/코드</th>
            <th class="right sortable" data-sort="close">현재가</th>
            <th class="right sortable" data-sort="ret">3개월 수익률</th>
            <th class="right sortable" data-sort="pred60">예측수익률(60d)</th>
            <th class="right sortable" data-sort="pred90">예측수익률(90d)</th>
            <th class="right sortable" data-sort="mdd60">예상 MDD(60d)</th>
            <th class="sortable score-col" data-sort="score">
              <span class="tooltip" title="R(파랑): 모멘텀/수익률&#10;P(청록): Top20 확률&#10;Q(연두): 재무/기초체력&#10;T(보라): 기술지표&#10;M(하늘): 예측 수익률&#10;RP(빨강): 낙폭 감점&#10;길이 비중으로 스트립 표시">점수·스트립</span>
            </th>
            <th>액션</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="center">불러오는 중...</td></tr>
        </tbody>
      </table>
      <div class="status" id="status"></div>
    </div>
  </div>

  <!-- Trade modal -->
  <div class="overlay" id="tradeOverlay">
    <div class="trade-modal">
      <div class="trade-modal-header">
        <div class="trade-modal-title" id="tradeModalTitle">매수 입력</div>
        <button class="modal-close" onclick="closeTradeModal()">닫기</button>
      </div>
      <div class="trade-field">
        <div class="trade-label" id="tradeInfo"></div>
      </div>
      <div class="trade-field">
        <div class="trade-label">날짜</div>
        <input id="tradeDate" type="date" class="trade-input">
      </div>
      <div class="trade-field">
        <div class="trade-label">수량</div>
        <input id="tradeQty" type="number" class="trade-input" min="1">
      </div>
      <div class="trade-field">
        <div class="trade-label">가격</div>
        <input id="tradePrice" type="number" class="trade-input" min="1">
      </div>
      <div class="trade-actions">
        <button onclick="saveTrade()">저장</button>
        <button onclick="closeTradeModal()">취소</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : null; };
    let universe = [];
    let rankMap = new Map();
    const sortState = { key: "score", dir: "desc" };
    let alertHidden = false;
    let tradeCtx = { side:"BUY", code:"", name:"" };

    const fmtPct = (v, digits = 2) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return "-";
      return (n * 100).toFixed(digits) + "%";
    };
    const getRiskClass = (mdd) => {
      if (!Number.isFinite(mdd)) return "";
      if (mdd <= -0.3) return "neg";
      if (mdd <= -0.15) return "warn";
      return "pos";
    };

    function buildRank(rows) {
      const arr = rows.filter(r => Number.isFinite(+r.final_score) || Number.isFinite(+r.score))
        .sort((a,b)=>{
          const af = Number.isFinite(+a.final_score)?+a.final_score:(Number.isFinite(+a.score)?+a.score:-Infinity);
          const bf = Number.isFinite(+b.final_score)?+b.final_score:(Number.isFinite(+b.score)?+b.score:-Infinity);
          return bf-af;
        });
      rankMap = new Map();
      arr.forEach((r,i)=>rankMap.set(r.code, i+1));
    }

    function applySort(rows){
      const {key,dir}=sortState;
      const g=(r)=>{
        switch(key){
          case "name": return (r.name||"").toLowerCase();
          case "code": return (r.code||"").toLowerCase();
          case "market": return (r.market||"").toLowerCase();
          case "close": return toNum(r.close) ?? -Infinity;
          case "ret": return toNum(r.ret_3m) ?? -Infinity;
          case "pred60": return toNum(r.pred_return_60d) ?? -Infinity;
          case "pred90": return toNum(r.pred_return_90d) ?? -Infinity;
          case "mdd60": return toNum(r.pred_mdd_60d) !== null ? -toNum(r.pred_mdd_60d) : -Infinity;
          case "rank": return rankMap.get(r.code) ?? Infinity;
          case "score":
          default:
            return Number.isFinite(+r.final_score)?+r.final_score:(Number.isFinite(+r.score)?+r.score:-Infinity);
        }
      };
      return rows.sort((a,b)=>{
        const va=g(a), vb=g(b);
        if(va<vb) return dir==="asc"?-1:1;
        if(va>vb) return dir==="asc"?1:-1;
        return 0;
      });
    }

    function buildStrip(r){
      const R = toNum(r.ret_score)||0;
      const P = toNum(r.prob_score)||0;
      const Q = toNum(r.qual_score)||0;
      const T = toNum(r.tech_score)||0;
      const M = toNum(r.pred_score)||0;
      const RP= toNum(r.risk_penalty)||0;
      let total = R+P+Q+T+M+RP;
      if(!Number.isFinite(total) || total<=0) total=1;
      const minPct=0.5;
      const seg=(val,cls,label,desc)=>{
        const pct=Math.max((val/total)*100,minPct);
        const tooltip = `${label}: ${val.toFixed(1)}점\n${desc}`;
        return `<div class="seg ${cls}" style="flex-basis:${pct}%;" title="${tooltip}"></div>`;
      };
      return `
        <div class="score-cell">
          <span class="score-val">${Number.isFinite(+r.final_score)?(+r.final_score).toFixed(1)+'점':'-'}</span>
          <div class="score-strip">
            ${seg(R,'seg-R','R (Return Score)','최근 모멘텀/수익률 기반')}
            ${seg(P,'seg-P','P (Probability Score)','모델이 예측한 Top20 확률')}
            ${seg(Q,'seg-Q','Q (Quality Score)','재무/기초체력 점수')}
            ${seg(T,'seg-T','T (Tech Score)','기술적 지표 기반')}
            ${seg(M,'seg-M','M (Model Score)','예측 수익률 기반')}
            ${seg(RP,'seg-RP','RP (Risk Penalty)','예상 낙폭 감점')}
          </div>
        </div>`;
    }

    function render(){
      const q = ($("#q").value||"").trim().toLowerCase();
      let rows = universe.slice();
      const mktFilter = ($("#market").value||"ALL").toUpperCase();
      const sectorFilter = ($("#sector").value||"ALL");
      if(mktFilter!=="ALL") rows = rows.filter(r => (r.market||"").toUpperCase()===mktFilter);
      if(sectorFilter!=="ALL") rows = rows.filter(r => (r.sector||"")===sectorFilter);
      if(q) rows = rows.filter(r => (r.code||"").toLowerCase().includes(q) || (r.name||"").toLowerCase().includes(q));
      if(!rows.length){ $("#tbody").innerHTML='<tr><td colspan="10" class="center">표시할 데이터가 없습니다</td></tr>'; return; }
      rows = applySort(rows);
      const html = rows.map(r=>{
        const pred60=toNum(r.pred_return_60d); const pred90=toNum(r.pred_return_90d);
        const ret3 = toNum(r.ret_3m); const mdd=toNum(r.pred_mdd_60d);
        const link = `./detail.html?code=${encodeURIComponent(r.code)}`;
        return `
          <tr onclick="location.href='${link}'" style="cursor:pointer">
            <td class="rank">${rankMap.get(r.code)??"-"}</td>
            <td><div class="cell-market">${(r.market||"").toUpperCase()} <span class="sector">(${r.sector||"-"})</span></div></td>
            <td><div class="cell-name"><div class="name">${r.name||r.code}</div><div class="code">${r.code}</div></div></td>
            <td class="right">${Number.isFinite(+r.close)?Number(r.close).toLocaleString():"-"}</td>
            <td class="right ${ret3>=0?'pos':'neg'}">${fmtPct(ret3)}</td>
            <td class="right ${pred60>=0?'pos':'neg'}">${fmtPct(pred60)}</td>
            <td class="right ${pred90>=0?'pos':'neg'}">${fmtPct(pred90)}</td>
            <td class="right">${Number.isFinite(mdd)?`<span class="pill ${getRiskClass(mdd)}">${(mdd*100).toFixed(2)}%</span>`:"-"}</td>
            <td class="right">${buildStrip(r)}</td>
            <td>
              <button onclick="openTradeModal('BUY','${r.code}','${r.name||r.code}', event)">매수</button>
              <button onclick="openTradeModal('SELL','${r.code}','${r.name||r.code}', event)">매도</button>
            </td>
          </tr>`;
      }).join("");
      $("#tbody").innerHTML = html;
    }

    async function fetchEnv(){
      try{
        const res=await fetch("/api/health");
        const info=await res.json();
        $("#envBadge").textContent = info?.status==="ok" ? (info.demo ? "DEMO":"LIVE") : "상태 불명";
      }catch{ $("#envBadge").textContent="상태 불명"; }
    }

    function populateSectors(rows){
      const select=$("#sector");
      const sectors=Array.from(new Set(rows.map(r=>r.sector||"").filter(Boolean))).sort((a,b)=>a.localeCompare(b,"ko"));
      select.innerHTML='<option value="ALL">전체분야</option>'+sectors.map(s=>`<option value="${s}">${s}</option>`).join("");
      select.onchange=render;
    }

    async function fetchRanking(){
      $("#status").textContent="불러오는 중...";
      try{
        const res=await fetch("/api/ranking");
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        universe=Array.isArray(data)?data:(Array.isArray(data?.data)?data.data:[]);
        buildRank(universe);
        populateSectors(universe);
        render();
        $("#status").textContent=`총 ${universe.length}종목`;
      }catch(e){
        console.error(e);
        $("#status").textContent="불러오기 실패";
      }
    }

    function openTradeModal(side, code, name, e){
      if(e && e.stopPropagation) e.stopPropagation();
      tradeCtx = { side, code, name };
      const overlay=$("#tradeOverlay");
      const title=$("#tradeModalTitle");
      const info=$("#tradeInfo");
      const date=$("#tradeDate");
      const qty=$("#tradeQty");
      const price=$("#tradePrice");
      if(title) title.textContent = side==="BUY" ? "매수 입력" : "매도 입력";
      if(info) info.textContent = `${name} (${code})`;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      if(date) date.value = `${yyyy}-${mm}-${dd}`;
      if(qty) qty.value = "";
      if(price) price.value = "";
      if(overlay) overlay.style.display="flex";
    }
    function closeTradeModal(){
      const overlay=$("#tradeOverlay");
      if(overlay) overlay.style.display="none";
    }
    async function saveTrade(){
      const date = $("#tradeDate")?.value;
      const qty = Number($("#tradeQty")?.value);
      const price = Number($("#tradePrice")?.value);
      if(!date || !Number.isFinite(qty) || qty<=0 || !Number.isFinite(price) || price<=0){
        alert("날짜/수량/가격을 올바르게 입력하세요.");
        return;
      }
      const payload = { side: tradeCtx.side, code: tradeCtx.code, date, qty, price };
      try{
        const res = await fetch("/api/trades", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error("HTTP "+res.status);
        alert("저장되었습니다.");
        closeTradeModal();
      }catch(err){
        console.error(err);
        alert("저장 실패: "+err.message);
      }
    }

    function setAlertHidden(flag){
      alertHidden = flag;
      const box = $("#marketAlert");
      const btn = $("#alertToggleBtn");
      if(box) box.classList.toggle("hidden", flag);
      if(btn) btn.textContent = flag ? "알림 펼치기" : "알림 숨기기";
    }

    async function fetchMarketStatus(){
      const box=$("#marketAlert");
      if(!box) return;
      try{
        const res=await fetch("/api/market/status");
        if(!res.ok) throw new Error("HTTP "+res.status);
        const m=await res.json();
        const isUp = m.market_up === true;
        const lines=[];
        const dateStr = m.status_date || "";
        if(dateStr) lines.push(`${dateStr} 기준`);
        if(Number.isFinite(m.kospi_close) && Number.isFinite(m.kospi_ma20)){
          lines.push(`KOSPI ${Number(m.kospi_close).toLocaleString()} / MA20 ${Number(m.kospi_ma20).toLocaleString()}`);
        }
        if(Number.isFinite(m.vol_5d)){
          lines.push(`5일 변동성 ${(m.vol_5d*100).toFixed(2)}% (기준: 3% 미만)`);
        }
        if(Number.isFinite(m.foreign_5d)){
          lines.push(`최근 5영업일 외국인 순매수 ${Number(m.foreign_5d).toLocaleString()}`);
        }
        const tag = isUp
          ? '<span class="tag good">상승 추세</span>'
          : '<span class="tag bad">⚠️ 매수 주의</span>';
        box.innerHTML = `${tag}<div class="lines">${lines.join("<br>")}</div>`;
        box.classList.toggle("hidden", alertHidden);
      }catch(e){
        console.warn("market status load fail", e);
        box.classList.add("hidden");
      }
    }

    // init
    (async function(){
      await fetchEnv();
      await fetchMarketStatus();
      await fetchRanking();
      setAlertHidden(false);
      $("#q").addEventListener("input", render);
      $("#market").addEventListener("change", render);
      $("#sector").addEventListener("change", render);
      document.querySelectorAll("th[data-sort]").forEach(th=>{
        th.addEventListener("click", ()=>{
          const key=th.dataset.sort;
          if(sortState.key===key) sortState.dir = sortState.dir==="asc"?"desc":"asc";
          else { sortState.key=key; sortState.dir="desc"; }
          render();
        });
      });
      if($("#recoBtn")) $("#recoBtn").addEventListener("click", (e)=>{e.preventDefault(); window.location.href='./ranking.html';});
      if($("#holdingsBtn")) $("#holdingsBtn").addEventListener("click", (e)=>{e.preventDefault(); window.location.href='./holdings.html';});
      if($("#tradeHistoryBtn")) $("#tradeHistoryBtn").addEventListener("click", (e)=>{e.preventDefault(); window.location.href='./trade-history.html';});
      if($("#alertToggleBtn")) $("#alertToggleBtn").addEventListener("click", (e)=>{e.preventDefault(); setAlertHidden(!alertHidden);});
    })();
  </script>
</body>
</html>
