<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Stock Analyzer - ìƒì„¸</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-soft: #0b1020;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22c55e;
      --danger: #ef4444;
      --warn: #facc15;
      --table-border: #1f2937;
      --grid: #1f2937;
      --ma5: #60a5fa;
      --ma20: #f59e0b;
      --ma60: #22c55e;
      --close: #e5e7eb;
      --ret: #2f81f7;
      --prob: #14b8a6;
      --qual: #65c466;
      --tech: #8b5cf6;
      --model: #38bdf8;
      --rp: #f97373;
    }
    html, body { margin:0; padding:0; background: var(--bg); color: var(--text); font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    a { color:#60a5fa; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    header h1 { font-size:20px; margin:0; }
    .badge { padding:4px 10px; border-radius:999px; border:1px solid var(--table-border); background: #0b1020; color: var(--muted); font-size:12px; }
    .layout { display:grid; grid-template-columns: 420px 1fr; gap:16px; align-items:start; }
    .detail-left { display:flex; flex-direction:column; gap:16px; }
    .cards { display:flex; flex-direction:column; gap:16px; }
    .card { background:#070f1f; border-radius:14px; padding:16px 20px; box-shadow:0 14px 30px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.03); border: none; }
    .detail-card-title { font-size:0.9rem; font-weight:600; margin:0 0 8px; letter-spacing:0.03em; opacity:0.9; display:flex; align-items:center; gap:8px; }
    .sub { color: var(--muted); font-size:12px; }
    .row { display:flex; flex-wrap:wrap; gap:10px 16px; }
    .info-item { flex:1 1 48%; min-width:150px; }
    .info-item .label { color: var(--muted); font-size:12px; }
    .info-item .value { font-weight:600; margin-top:2px; }
    .detail-row { display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px; }
    .detail-row-label { opacity:0.7; }
    .detail-row-value { font-variant-numeric: tabular-nums; }
    .summary-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:12px; }
    .summary-name { font-size:1rem; font-weight:600; }
    .summary-code { font-size:0.8rem; opacity:0.7; }
    .summary-market { font-size:0.8rem; opacity:0.8; margin-top:2px; }
    .summary-trend { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:999px; font-size:0.75rem; font-weight:500; }
    .summary-trend.up { color:#4ade80; background:rgba(34,197,94,0.12); }
    .summary-trend.strong-up { color:#22c55e; background:rgba(34,197,94,0.18); }
    .summary-trend.down { color:#f97373; background:rgba(248,113,113,0.14); }
    .summary-trend.neutral { color:#e5e7eb; background:rgba(148,163,184,0.16); }
    .trend-icon { font-size:0.8rem; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .chip { padding:4px 8px; border-radius:8px; background: #0b1020; border:1px solid var(--table-border); font-size:12px; }
    .score-row { display:flex; align-items:center; gap:10px; margin:6px 0; }
    .score-label { width:110px; color: var(--muted); font-size:13px; }
    .score-bar { flex:1; height:8px; border-radius:999px; background: rgba(255,255,255,0.08); overflow:hidden; position:relative; }
    .score-fill { position:absolute; top:0; left:0; bottom:0; border-radius:999px; }
    .score-val { width:55px; text-align:right; font-weight:600; }
    .pos { color:#22c55e; }
    .neg { color:#ef4444; }
    .warn { color: var(--warn); }
    .pill { display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); font-size:12px; }
    .tech-sparkline-wrap { margin-top:10px; }
    #sparklineCanvas { width:100%; height:40px; }
    .sparkline-label { font-size:0.75rem; opacity:0.7; margin-top:2px; }
    .risk-comment { margin-top:8px; padding-top:6px; border-top:1px solid rgba(148,163,184,0.2); font-size:0.8rem; opacity:0.9; line-height:1.4; }
    canvas { width:100%; height:360px; border: 1px solid var(--table-border); background:#0b1020; border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:6px 4px; border-bottom:1px solid var(--table-border); }
    th { color: var(--muted); text-align:left; }
    .status { color: var(--muted); font-size:12px; margin-top:6px; }
    @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><a href="./">ì˜ˆì¸¡ ë¦¬ìŠ¤íŠ¸</a> Â· ìƒì„¸ ë¦¬í¬íŠ¸</h1>
      <div id="title" class="badge">ì¢…ëª©ì½”ë“œ: -</div>
    </header>

    <div class="layout">
      <!-- ì™¼ìª½: AI ë¦¬í¬íŠ¸ ì¹´ë“œ -->
      <div class="cards detail-left">
        <div class="card detail-card" id="card-summary">
          <div class="detail-card-title">ì¢…ëª© ìš”ì•½</div>
          <div class="summary-header">
            <div>
              <div class="summary-name" id="summaryName">-</div>
              <div class="summary-code" id="summaryCode">-</div>
              <div class="summary-market" id="summaryMeta">-</div>
            </div>
            <div class="summary-trend neutral" id="summaryTrend">
              <span class="trend-icon">â– </span>
              <span class="trend-label">ì¤‘ë¦½</span>
            </div>
          </div>
          <div class="chips" id="summaryChips"></div>
          <div class="sub" id="aiComment" style="margin-top:8px;">ì˜ˆì¸¡ ìˆ˜ìµë¥ ê³¼ ë¦¬ìŠ¤í¬ë¥¼ ì¢…í•©í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</div>
        </div>

        <div class="card detail-card" id="card-tech">
          <h3 class="detail-card-title">ğŸ“Š ê¸°ìˆ  ìš”ì•½</h3>
          <div class="row">
            <div class="info-item"><div class="label">ì¢…ê°€</div><div class="value" id="vClose">-</div></div>
            <div class="info-item"><div class="label">MA5 / MA20 / MA60</div><div class="value" id="vMA">-</div></div>
            <div class="info-item"><div class="label">RSI(14)</div><div class="value" id="vRSI">-</div><div class="sub" id="vRSIText"></div></div>
            <div class="info-item"><div class="label">ë³€ë™ì„±(20)</div><div class="value" id="vVol">-</div><div class="sub" id="vVolText"></div></div>
          </div>
          <div class="tech-sparkline-wrap">
            <canvas id="sparklineCanvas" width="160" height="40"></canvas>
            <div class="sparkline-label">ìµœê·¼ 30ì¼ ì¢…ê°€ ì¶”ì´</div>
          </div>
        </div>

        <div class="card detail-card" id="card-score">
          <h3 class="detail-card-title">ğŸ” ì ìˆ˜ ë¶„í•´</h3>
          <div class="score-row"><div class="score-label">RET (ìˆ˜ìµë¥ )</div><div class="score-bar"><div class="score-fill" id="barRet"></div></div><div class="score-val" id="valRet">-</div></div>
          <div class="score-row"><div class="score-label">PROB (í™•ë¥ )</div><div class="score-bar"><div class="score-fill" id="barProb"></div></div><div class="score-val" id="valProb">-</div></div>
          <div class="score-row"><div class="score-label">QUAL (ì¬ë¬´)</div><div class="score-bar"><div class="score-fill" id="barQual"></div></div><div class="score-val" id="valQual">-</div></div>
          <div class="score-row"><div class="score-label">TECH (ê¸°ìˆ )</div><div class="score-bar"><div class="score-fill" id="barTech"></div></div><div class="score-val" id="valTech">-</div></div>
          <div class="score-row"><div class="score-label">MODEL (ì˜ˆì¸¡)</div><div class="score-bar"><div class="score-fill" id="barModel"></div></div><div class="score-val" id="valModel">-</div></div>
          <div class="score-row"><div class="score-label">RISK PENALTY</div><div class="score-bar"><div class="score-fill" id="barRP"></div></div><div class="score-val" id="valRP">-</div></div>
        </div>

        <div class="card detail-card" id="card-risk">
          <h3 class="detail-card-title">âš  ë¦¬ìŠ¤í¬ ë¶„ì„</h3>
          <div class="row">
            <div class="info-item"><div class="label">ì˜ˆìƒ MDD(60d)</div><div class="value" id="vMdd">-</div></div>
            <div class="info-item"><div class="label">ë³€ë™ì„±(20)</div><div class="value" id="vVolRisk">-</div></div>
            <div class="info-item"><div class="label">ë¦¬ìŠ¤í¬ ê°ì </div><div class="value" id="vRP">-</div></div>
          </div>
          <div class="risk-comment" id="riskComment"></div>
        </div>

        <div class="card detail-card" id="card-predict">
          <h3 class="detail-card-title">ğŸ“ˆ AI ì˜ˆì¸¡ ìš”ì•½</h3>
          <div class="row">
            <div class="info-item"><div class="label">ì˜ˆì¸¡ìˆ˜ìµë¥ (60d)</div><div class="value" id="vPred60">-</div></div>
            <div class="info-item"><div class="label">ì˜ˆì¸¡ìˆ˜ìµë¥ (90d)</div><div class="value" id="vPred90">-</div></div>
            <div class="info-item"><div class="label">Top20 í™•ë¥ (60d)</div><div class="value" id="vProb60">-</div></div>
            <div class="info-item"><div class="label">Top20 í™•ë¥ (90d)</div><div class="value" id="vProb90">-</div></div>
          </div>
          <div class="sub" id="predText" style="margin-top:6px;"></div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì°¨íŠ¸/í…Œì´ë¸” ì˜ì—­ -->
      <div style="flex:1; min-width: 320px;">
        <canvas id="chart" width="900" height="360"></canvas>
        <div class="legend" style="color:var(--muted); margin-top:8px;">
          <span><span class="dot" style="background: var(--close)"></span>Close</span>
          <span><span class="dot" style="background: var(--ma5)"></span>MA5</span>
          <span><span class="dot" style="background: var(--ma20)"></span>MA20</span>
          <span><span class="dot" style="background: var(--ma60)"></span>MA60</span>
        </div>
        <div style="margin-top:6px; color:#94a3b8; font-size:12px; line-height:1.5;">
          <div><b>MA5/MA20/MA60</b>: ìµœê·¼ 5/20/60ì¼ ì¢…ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œ ì´ë™í‰ê· </div>
          <div><b>RSI(14)</b>: 14ì¼ ìƒëŒ€ê°•ë„ì§€ìˆ˜(ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ ì§€í‘œ, 0~100)</div>
          <div><b>ë³€ë™ì„±(20)</b>: ìµœê·¼ 20ì¼ ìˆ˜ìµë¥ ì˜ í‘œì¤€í¸ì°¨(ì¼ë³„)</div>
          <div><b>ì˜ˆì¸¡ ìˆ˜ìµë¥ </b>: ëª¨ë¸ì´ ì¶”ì •í•œ í–¥í›„ ìˆ˜ìµë¥ (60/90ì¼)</div>
        </div>
        <div id="status" class="status">/api/stocks/:code ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

        <div style="margin-top: 12px; max-height: 260px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th style="text-align:left;">ë‚ ì§œ</th>
                <th style="text-align:right;">ì¢…ê°€</th>
              </tr>
            </thead>
            <tbody id="priceTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    function getQuery(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }
    const fmtNum = (x) => (x == null || Number.isNaN(x) ? "-" : Number(x).toLocaleString());
    const fmt2 = (x) => (x == null || Number.isNaN(x) ? "-" : Number(x).toFixed(2));
    const fmtPct = (x) => (x == null || Number.isNaN(x) ? "-" : (Number(x) * 100).toFixed(2) + "%");

    function scaleY(values, h, pad=20) {
      const arr = values.filter(v => v != null && !Number.isNaN(v));
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const range = max - min || 1;
      return (v) => {
        if (v == null || Number.isNaN(v)) return null;
        return Math.round((1 - (v - min) / range) * (h - pad*2) + pad);
      };
    }

    function drawSeries(ctx, xs, ys, color) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      let started = false;
      for (let i = 0; i < xs.length; i++) {
        const x = xs[i], y = ys[i];
        if (y == null) { started = false; continue; }
        if (!started) { ctx.moveTo(x, y); started = true; }
        else { ctx.lineTo(x, y); }
      }
      ctx.stroke();
    }

    function drawGrid(ctx, w, h) {
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i = 0; i <= 6; i++) {
        const y = Math.round((h / 6) * i);
        ctx.moveTo(0, y); ctx.lineTo(w, y);
      }
      ctx.stroke();
    }

    function renderSparkline(canvasId, prices){
      const canvas = document.getElementById(canvasId);
      if(!canvas || !prices || !prices.length) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const span = max - min || 1;
      const stepX = prices.length>1 ? w / (prices.length - 1) : w;
      ctx.beginPath();
      prices.forEach((p,i)=>{
        const x = i * stepX;
        const y = h - ((p - min) / span) * (h - 4) - 2;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.lineWidth = 1.5;
      ctx.strokeStyle = '#38bdf8';
      ctx.stroke();
      const lastX = (prices.length - 1) * stepX;
      const lastY = h - ((prices[prices.length - 1] - min) / span) * (h - 4) - 2;
      ctx.beginPath();
      ctx.arc(lastX,lastY,2.2,0,Math.PI*2);
      ctx.fillStyle = '#facc15';
      ctx.fill();
    }

    async function fetchDetail(code) {
      $("#status").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      try {
        const res = await fetch(`/api/stocks/${encodeURIComponent(code)}?limit=90`);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        $("#status").textContent = `ìµœê·¼ ${data.count}ê°œ ìˆ˜ì‹ `;
        return data;
      } catch (e) {
        $("#status").textContent = "ì˜¤ë¥˜: " + e.message;
        return null;
      }
    }

    function bandProbability(prob){
      if (!Number.isFinite(prob)) return "ì •ë³´ ë¶€ì¡±";
      if (prob >= 70) return "ë†’ìŒ";
      if (prob >= 40) return "ì¤‘ê°„";
      return "ë‚®ìŒ";
    }
    function bandVol(vol, mdd){
      if (Number.isFinite(mdd) && mdd <= -0.2) return "ë†’ìŒ";
      if (Number.isFinite(vol) && vol >= 0.03) return "ë†’ìŒ";
      if (Number.isFinite(vol) && vol <= 0.01) return "ë‚®ìŒ";
      return "ë³´í†µ";
    }
    function bandRSI(rsi){
      if (!Number.isFinite(rsi)) return "-";
      if (rsi < 30) return "ê³¼ë§¤ë„";
      if (rsi > 70) return "ê³¼ë§¤ìˆ˜";
      return "ì¤‘ë¦½";
    }
    function aiComment(pred60, qual, riskPenalty){
      if (!Number.isFinite(pred60)) return "ëª¨ë¸ ì˜ˆì¸¡ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      if (pred60 >= 0.25 && riskPenalty < 5) return "ìƒìŠ¹ ê°€ëŠ¥ì„±ì´ ë†’ê³  ë¦¬ìŠ¤í¬ëŠ” ë‚®ì€ í¸ì…ë‹ˆë‹¤.";
      if (pred60 >= 0.25 && riskPenalty >= 5) return "ìƒìŠ¹ ê°€ëŠ¥ì„±ì€ ë†’ì§€ë§Œ ë¦¬ìŠ¤í¬ë„ í° í¸ì…ë‹ˆë‹¤.";
      if (pred60 < 0.1 && qual >= 60) return "ìˆ˜ìµ ëª¨ë©˜í…€ì€ ì•½í•˜ì§€ë§Œ, ì¬ë¬´ ìƒíƒœëŠ” ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤.";
      return "ì˜ˆì¸¡ ìˆ˜ìµë¥ ê³¼ ë¦¬ìŠ¤í¬ë¥¼ ê· í˜• ìˆê²Œ í™•ì¸í•˜ì„¸ìš”.";
    }

    // ìƒìŠ¹/í•˜ë½ íŒë‹¨ + íˆ´íŒ
    function setupSummaryTrend(pred60, pred90, rp){
      const el = document.getElementById('summaryTrend');
      if (!el) return;
      const iconEl = el.querySelector('.trend-icon');
      const labelEl = el.querySelector('.trend-label');
      const avgPred = ((Number(pred60)||0) + (Number(pred90)||0)) / 2;
      rp = Number(rp)||0;
      let dir='neutral', label='ì¤‘ë¦½', icon='â– ', desc='ì˜ˆì¸¡ì´ ì¤‘ë¦½ êµ¬ê°„ì…ë‹ˆë‹¤.';
      let rule='í‰ê·  ì˜ˆì¸¡ìˆ˜ìµë¥  -3%~8%';
      if (avgPred > 0.25 && rp < 10) {
        dir='strong-up'; label='ìƒìŠ¹ ê°•ì„¸'; icon='â–²'; desc='ì˜ˆì¸¡ ìˆ˜ìµë¥ ì´ ë†’ê³  ë¦¬ìŠ¤í¬ ê°ì ì€ ë‚®ì€ í¸ì…ë‹ˆë‹¤.'; rule='í‰ê·  ì˜ˆì¸¡ìˆ˜ìµë¥ >25% & RP<10';
      } else if (avgPred > 0.08) {
        dir='up'; label='ìƒìŠ¹ ìš°ìœ„'; icon='â–²'; desc='ì˜ˆì¸¡ ìˆ˜ìµë¥ ì´ ìš°ìœ„ì´ë©° ë¦¬ìŠ¤í¬ëŠ” ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤.'; rule='í‰ê·  ì˜ˆì¸¡ìˆ˜ìµë¥ >8%';
      } else if (avgPred < -0.03) {
        dir='down'; label='í•˜ë½ ì£¼ì˜'; icon='â–¼'; desc='ì˜ˆì¸¡ í•˜ë½ ê°€ëŠ¥ì„±ì´ ìˆì–´ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.'; rule='í‰ê·  ì˜ˆì¸¡ìˆ˜ìµë¥ <-3%';
      }
      const avgPct = (avgPred*100).toFixed(2)+'%';
      const rpText = rp.toFixed(1);
      el.classList.remove('up','strong-up','down','neutral');
      el.classList.add(dir);
      if(iconEl) iconEl.textContent = icon;
      if(labelEl) labelEl.textContent = label;
      el.title = `${label}\n${desc}\nì¡°ê±´: ${rule}\ní˜„ì¬: í‰ê·  ì˜ˆì¸¡ìˆ˜ìµë¥  ${avgPct}, ë¦¬ìŠ¤í¬ê°ì  ${rpText}`;
    }

    function renderDetail(data) {
      if (!data || !Array.isArray(data.rows) || !data.rows.length) {
        $("#status").textContent = "í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤";
        return;
      }
      const rows = data.rows;
      const latest = data.latest || rows[rows.length - 1];
      const name = (data.name || "");
      $("#title").textContent = name ? `ì¢…ëª©ì½”ë“œ: ${data.code} (${name})` : `ì¢…ëª©ì½”ë“œ: ${data.code}`;

      // ìš”ì•½ ì¹´ë“œ + íŠ¸ë Œë“œ
      $("#summaryName").textContent = name || data.code;
      $("#summaryCode").textContent = `(${data.code})`;
      $("#summaryMeta").textContent = `${(data.market||"").toUpperCase()} Â· ${data.sector||"-"}`;
      const chips = [];
      if (Number.isFinite(+data.final_score_rank)) chips.push(`ìµœì¢… ì ìˆ˜: ${Number(data.final_score_rank).toFixed(1)}ì `);
      const probBand = bandProbability(Number(data.prob_score));
      chips.push(`ëª¨ë¸ ì‹ ë¢°ë„: ${probBand}`);
      const volBand = bandVol(Number(data.volatility_20), Number(data.pred_mdd_60d));
      chips.push(`ë³€ë™ì„±: ${volBand}`);
      $("#summaryChips").innerHTML = chips.map(c=>`<span class="chip">${c}</span>`).join("");
      $("#aiComment").textContent = aiComment(Number(data.pred_return_60d), Number(data.qual_score), Number(data.risk_penalty));
      setupSummaryTrend(data.pred_return_60d, data.pred_return_90d, data.risk_penalty);

      // ê¸°ìˆ  ìš”ì•½
      $("#vClose").textContent = fmtNum(latest.close);
      $("#vMA").textContent = `${fmtNum(latest.ma_5)} / ${fmtNum(latest.ma_20)} / ${fmtNum(latest.ma_60)}`;
      $("#vRSI").textContent = fmt2(latest.rsi_14);
      $("#vRSIText").textContent = `(${bandRSI(Number(latest.rsi_14))})`;
      $("#vVol").textContent = fmt2(latest.vol_20);
      $("#vVolText").textContent = `(${bandVol(Number(latest.vol_20))})`;

      // ì ìˆ˜ ë§‰ëŒ€
      const setBar = (idBar, idVal, val, color) => {
        const v = Number(val);
        document.querySelector(idVal).textContent = Number.isFinite(v)? v.toFixed(1)+"ì " : "-";
        const el = document.querySelector(idBar);
        if(el) { el.style.width = (Number.isFinite(v)? Math.max(5,v)/100*100 : 0)+'%'; el.style.background = color; }
      };
      setBar("#barRet","#valRet", data.ret_score, "var(--ret)");
      setBar("#barProb","#valProb", data.prob_score, "var(--prob)");
      setBar("#barQual","#valQual", data.qual_score, "var(--qual)");
      setBar("#barTech","#valTech", data.tech_score, "var(--tech)");
      setBar("#barModel","#valModel", data.pred_score, "var(--model)");
      setBar("#barRP","#valRP", data.risk_penalty, "var(--rp)");

      // ë¦¬ìŠ¤í¬ ì¹´ë“œ
      $("#vMdd").textContent = fmtPct(data.pred_mdd_60d);
      $("#vVolRisk").textContent = fmt2(data.volatility_20);
      $("#vRP").textContent = Number.isFinite(+data.risk_penalty)? Number(data.risk_penalty).toFixed(1)+"ì " : "-";
      const mdd = Number(data.pred_mdd_60d);
      const vol = Number(data.volatility_20);
      const rp = Number(data.risk_penalty)||0;
      let mddText;
      if (Number.isFinite(mdd)) {
        if (mdd <= -0.2)       mddText = "ì˜ˆìƒ ìµœëŒ€ í•˜ë½í­ì´ ë§¤ìš° í° í¸ì…ë‹ˆë‹¤";
        else if (mdd <= -0.12) mddText = "ì˜ˆìƒ ìµœëŒ€ í•˜ë½í­ì´ ë‹¤ì†Œ í° í¸ì…ë‹ˆë‹¤";
        else if (mdd <= -0.07) mddText = "ì˜ˆìƒ ìµœëŒ€ í•˜ë½í­ì´ ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤";
        else                   mddText = "ì˜ˆìƒ ìµœëŒ€ í•˜ë½í­ì´ ë¹„êµì  ë‚®ì€ í¸ì…ë‹ˆë‹¤";
      } else {
        mddText = "ì˜ˆìƒ í•˜ë½í­ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
      }
      let volText;
      if (Number.isFinite(vol)) {
        if (vol >= 0.04)       volText = "ë‹¨ê¸° ë³€ë™ì„±ë„ ë†’ì€ í¸ì…ë‹ˆë‹¤";
        else if (vol >= 0.025) volText = "ë‹¨ê¸° ë³€ë™ì„±ì€ ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤";
        else                   volText = "ë‹¨ê¸° ë³€ë™ì„±ì€ ë‚®ì€ í¸ì…ë‹ˆë‹¤";
      } else {
        volText = "ë‹¨ê¸° ë³€ë™ì„± ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
      }
      let rpText;
      if (rp >= 15)          rpText = "ë¦¬ìŠ¤í¬ ê°ì ì´ ì»¤ì„œ ë³´ìˆ˜ì ì¸ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤";
      else if (rp >= 5)      rpText = "ë¦¬ìŠ¤í¬ ê°ì ì´ ì¼ë¶€ ë°˜ì˜ëœ ìƒíƒœì…ë‹ˆë‹¤";
      else                   rpText = "ì ìˆ˜ì— ë°˜ì˜ëœ ë¦¬ìŠ¤í¬ëŠ” í¬ì§€ ì•ŠìŠµë‹ˆë‹¤";
      $("#riskComment").textContent = `${mddText}. ${volText}. ${rpText}.`;

      // ì˜ˆì¸¡ ì¹´ë“œ
      $("#vPred60").textContent = fmtPct(data.pred_return_60d);
      $("#vPred90").textContent = fmtPct(data.pred_return_90d);
      $("#vProb60").textContent = Number.isFinite(+data.prob_top20_60d)? (Number(data.prob_top20_60d)*100).toFixed(1)+"%" : "-";
      $("#vProb90").textContent = Number.isFinite(+data.prob_top20_90d)? (Number(data.prob_top20_90d)*100).toFixed(1)+"%" : "-";
      $("#predText").textContent = "60ì¼/90ì¼ ì˜ˆì¸¡ ìˆ˜ìµë¥ ê³¼ Top20 í™•ë¥ ì„ í•¨ê»˜ í™•ì¸í•˜ì„¸ìš”.";

      // ì°¨íŠ¸ ë Œë”
      const close = rows.map(r => Number(r.close));
      const ma5 = rows.map(r => Number(r.ma_5));
      const ma20 = rows.map(r => Number(r.ma_20));
      const ma60 = rows.map(r => Number(r.ma_60));
      const canvas = $("#chart");
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      drawGrid(ctx, w, h);
      const allVals = [];
      close.forEach(v => Number.isFinite(v) && allVals.push(v));
      ma5.forEach(v => Number.isFinite(v) && allVals.push(v));
      ma20.forEach(v => Number.isFinite(v) && allVals.push(v));
      ma60.forEach(v => Number.isFinite(v) && allVals.push(v));
      const toY = scaleY(allVals, h);
      const n = rows.length;
      const padX = 40;
      const step = (w - padX*2) / Math.max(1, n - 1);
      const xs = Array.from({length:n}, (_, i) => Math.round(padX + i * step));
      const ysClose = close.map(v => Number.isFinite(v) ? toY(v) : null);
      const ys5 = ma5.map(v => Number.isFinite(v) ? toY(v) : null);
      const ys20 = ma20.map(v => Number.isFinite(v) ? toY(v) : null);
      const ys60 = ma60.map(v => Number.isFinite(v) ? toY(v) : null);
      drawSeries(ctx, xs, ys60, getComputedStyle(document.documentElement).getPropertyValue('--ma60').trim());
      drawSeries(ctx, xs, ys20, getComputedStyle(document.documentElement).getPropertyValue('--ma20').trim());
      drawSeries(ctx, xs, ys5, getComputedStyle(document.documentElement).getPropertyValue('--ma5').trim());
      drawSeries(ctx, xs, ysClose, getComputedStyle(document.documentElement).getPropertyValue('--close').trim());

      // ë¯¸ë‹ˆ ìŠ¤íŒŒí¬ë¼ì¸(ìµœê·¼ 30ê°œ)
      const closes = rows.map(r => Number(r.close)).filter(v=>Number.isFinite(v));
      const last30 = closes.slice(-30);
      renderSparkline('sparklineCanvas', last30);

      const tbl = document.getElementById("priceTable");
      tbl.innerHTML = rows.slice().reverse().map(r => `
        <tr>
          <td>${r.date}</td>
          <td style="text-align:right;">${Number.isFinite(+r.close) ? Number(r.close).toLocaleString() : "-"}</td>
        </tr>
      `).join("");
    }

    (async function init() {
      const code = getQuery("code") || "005930";
      const data = await fetchDetail(code);
      renderDetail(data);
    })();
  </script>
</body>
</html>
