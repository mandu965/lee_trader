좋아, **하이레버리지장 v5.0에서 해야 할 것만** 깔끔하게 뽑아볼게.  
컨셉: **개인 투자자 환경에서 굴리는 베이직 버전 완성** 느낌

> ✅ = v5.0 필수  
> 🕒 = 여유 되면 같이 하면 좋은 것

---

## A. 데이터파이프·DB 정돈 (EPIC 2 중심)

### A-1. CSV → DB 원장화 (필수 인입 v5.0 범위)

* [x] `prices_daily_raw` 스텝:
  * 실행 시 **바로 `prices_raw` 테이블에 to_sql**
  * CSV(`prices_daily_raw.csv`)는 옵션(추가 백업/디버깅용)
  * DB `prices_raw`: rows=138043, date=2022-12-05~2025-12-04
* [x] `prices_daily_clean` 스텝 → `prices_clean` 테이블에 to_sql  
  * DB `prices_clean`: rows=137981, date=2022-12-05~2025-12-04
* [x] `prices_daily_adjusted` 스텝 → `prices_adjusted` 테이블에 to_sql  
  * DB `prices_adjusted`: rows=137981, date=2022-12-05~2025-12-04
* [x] `quality_builder` → `quality` 테이블에 to_sql  
  * DB `quality`: rows=1165, date=2019-12-31~2025-12-31
* [x] `feature_builder` → `features` 테이블에 to_sql  
  * DB `features`: rows=138512, date=2022-12-05~2025-12-03 (12-04 미반영)
* [x] `label_builder` → `labels` 테이블에 to_sql  
  * DB `labels`: rows=131977, date=2022-12-05~2025-10-23 (라벨 최신화 필요)
* [x] `model_predict` → `predictions` 테이블에 to_sql  
  * DB `predictions`: rows=202, date=2025-11-28~2025-12-03
* [x] `scoring`/`scores_final` 생성 스텝 → `daily_scores` 테이블에 to_sql  
  * DB `daily_scores`: rows=47540, date=2024-12-02~2025-12-01 (12-02 이후 미생성)
* [x] `ranking_builder` → `daily_ranking` 테이블에 to_sql  
  * DB `daily_ranking`: rows=202, date=2025-11-28~2025-12-03

### A-2. 스키마 정리

* [x] `schema.sql` 최종 정리  
  * 현재 SQLite에 만들어진 테이블 구조(실테이블: stocks/prices_raw/prices_clean/prices_adjusted/fact_price_daily/fundamentals/quality/features/labels/predictions/daily_scores/daily_ranking/market_status/trades/backtest_trades)와 일치하도록 갱신 완료.
* [x] `migrate_to_sqlite.py` 역할 축소/제거  
  * **정규 파이프라인만 돌려도 DB가 최신 상태가 되도록** 관리
  * 현황: 파이프라인이 DB에 직접 쓰는 구조이며, `migrate_to_sqlite.py`는 CSV→DB 리셋/재적재 스크립트(더는 필요치 않음). deprecated로 표기하고 사용 중단.

### A-3. 간단 데이터 검수

* [x] 파이프라인 전체 full run 후 최소 체크:
  * [x] `features` vs `labels`: features rows=138,512 date=2022-12-05~2025-12-03, labels rows=131,977 date=2022-12-05~2025-10-23 → 라벨 최신화 필요(10-23 이후 없음).
  * [x] `daily_ranking` 오늘 기준 row 수: max date=2025-12-03, rows=201 (예상 유니버스 대비 1종목 부족 가능).
  * [x] 샘플 join 검사: 2025-12-03에서 3종 모두 labels가 NULL(라벨 미갱신 영향), features는 정상. 예측/랭킹은 생성됨.

---

## B. 모델·점수 v5 베이스 (EPIC 3 + 리스크/예측 강화 1차)

### B-1. 모델 학습/예측 루틴 고정

* [x] `model_train.py`에서 **`realized_return_*` feature 제외** 로직 정리 (이미 코드 반영됨)
* [ ] `model_train` 실행 커맨드/옵션 README에 명시  
  * 예: `python python/model_train.py --target-col target_60d`
* [ ] `model_predict` 실행 커맨드 고정  
  * 예: `python python/model_predict.py --as-of YYYY-MM-DD` (옵션 필요 시)

### B-2. 점수 v5 기본버전 확정

* [ ] `scoring.py` 내에 들어가는  
  * `ret_score`
  * `prob_score`
  * `qual_score`
  * `tech_score`
  * `pred_score`
  * `risk_penalty`
  * `final_score`  
  를 **현재 쓰는 공식 그대로 v5.0 baseline으로 확정**하고 주석/문서 정리
  * 현황: `python/scoring.py` 함수는 z-score 기반 ret/prob/qual/tech/risk_penalty/final_score_v5 정의만 있음(실제 파이프라인에서는 미사용). `ranking_builder.py`는 별도 공식으로 `final_score` 산출.
* [ ] `scores_final.csv` + `daily_scores`가 **final_score 기준으로 잘 찍히는지 확인**
  * 현황: `data/scores_final.csv`/`daily_scores` 테이블에는 `score, composite`만 있고 `final_score` 없음. v5 공식 반영 필요.

### B-3. 예측률·점수 간단 검증 (v5.0 초안)

* [x] `score_backtest_from_labels.py` 최신 데이터로 실행  
  * labels 최신=2025-10-23 기준, merged rows=41,269, samples=925(top5)  
  * 평군 수익률(60d): 0.2606, 승률(>0): 66.7%  
  * final_score 분위수별 realized_return: [0.255, 0.309, 0.263, 0.220, 0.253] (상위 분위수 우위 뚜렷하지 않음)
* [ ] 🕒 `pred_return_60d` 분위수 vs 실제 realized_return_60d 평균 간단 출력  
  → 예측이 충분히라도 방향이 맞는지 확인 (v5.0에서 우선)  
  * 현황: 스크립트에서 `pred_return_60d` 컬럼 없어 None 출력 → 별도 분석 필요

---

## C. Node API & 기본 UI (EPIC 4, 5 + 추가 개선항 3,4,5 반영)

### C-1. Node API 최소 셋

* [x] `/api/ranking?date=YYYY-MM-DD`  
  * 기본 응답: `code, name, market, sector, final_score, pred_return_60d, pred_mdd_60d, quality_score, generated_at` 정도
  * 변경: `date` 쿼리 지원(없으면 최신일), DB `daily_ranking` 우선 후 ranking_final.csv fallback.
* [x] `/api/stocks/:code/history`  
  * 차트용: `date, close, final_score` 최소 제공
  * 변경: features + scores_final + daily_ranking.final_score join, predictions에서 최신 pred_return 보강.
* [x] `/api/trades` (get list)  
  * 기존 trades 엔드포인트 유지(추후 매매이력 정의 필요)

### C-2. 메인 페이지 (단일 화면) 초안 v5.0

* [x] 오늘 날짜 기준 Top20 리스트  
  * 필드: 순위, 종목명/코드, 시장, final_score, 예측수익률(60d), 예측MDD(60d), 퀄리티점수
* [x] 🕒 점수 브레이크다운 간단 그래프  
  * 각 종목 row에서 클릭 시 small modal에서  
    * `ret_score / prob_score / qual_score / tech_score / pred_score / risk_penalty` 소형 그래프
* [x] 🕒 비로그인/로그인 공개 범위 설정  
  * Top3까지만 노출 또는 점수 일부만 노출

### C-3. 종목 상세 화면 초안 v5.0

* [x] 가격 차트(기본: 최근 6개월)
* [x] 점수 브레이크다운 카드  
  * final_score 구성요소 기반 모멘텀 강함 / 리스크 보통 / 퀄리티 양호 등 한줄 메시지
* [x] 🕒 예측 vs 실제 간단 비교(최근 N회 예측 vs realized dot 표시)

---

## D. 스케줄링·운영 기초 (EPIC 1/2 일부 + 추가 개선항 6,11 반영)

### D-1. 파이프라인 자동 실행 (로컬 기준 v5.0)

* [ ] 하루 단위 전체 파이프라인 실행 스크립트  
  * 예: `run_pipeline_daily.sh` 또는 `.bat`  
  * 순서:  
    * `download_prices` → `clean` → `adjust` → `fundamentals/quality` → `features` → `labels` → `model_train(선택)` / `model_predict` → `scoring` → `ranking`
* [ ] Windows 작업 스케줄러 또는 WSL cron 설정  
  * 마감 후(예 17:30) 실행되게 설정

### D-2. 로그/에러 구조

* [ ] `logs/` 폴더 아래  
  * `pipeline_YYYYMMDD.log`
  * `errors_YYYYMMDD.log`  
    형태로 분리되게 조정
* [ ] 🕒 에러 발생 시 메일·슬랙 등으로 알림 추가 (후순위)

### D-3. 간단 호스팅 & 접속

* [ ] 로컬/서버 기준으로  
  * Node 서버 포트 고정 (예: 3000)
  * (선택) nginx 리버스 프록시로 LAN 내 다른 기기에서 접속 확인
* [ ] 🕒 커스텀 도메인/https는 **v5.1 이후**에 보기  
  * v5.0은 내 PC or NAS에서 돌아가는 버전 목표 설정

---

## E. 최소 보안·권한·문서 (EPIC 5 일부 + EPIC 8 + 추가 개선항 7,8,9 반영)

### E-1. 계정/권한 v5.0 최소 버전

* [ ] `users` 테이블(id, username, password_hash, role)
* [ ] Node에서 간단 로그인 API  
  * 세션 or JWT 둘 중 하나 (작업 용이한 쪽으로)
* [ ] 권한 구분:  
  * 비로그인: 오늘 Top3 + 간단 요약만  
  * 로그인: Top20 전체 / 상세 페이지  
  * (role=admin 구조만 잡아두고 세부 기능은 v5.1 이후)

### E-2. 최소 문서 뼈대만

* [ ] `docs/` 폴더 만들기
* [ ] 우선 문서 3개:  
  * `docs/architecture.md` 시스템 전체 구조 그림 + 간단 설명  
  * `docs/pipeline.md` 파이프라인 단계별로 어떤 데이터/CSV 만드는지  
  * `docs/db_schema.md` 주요 테이블(`features`, `labels`, `predictions`, `daily_ranking`, `trades`) 컬럼 설명
* [ ] 🕒 각 python 파일 위에 간단 docstring 정리  
  * 예: `"""features.csv/테이블 생성: 가격+퀄리티 기반 지표 추출"""`

---

## 오늘 정리: v5.0 범위 요약

* **데이터/모델**: DB 중심 파이프라인 + 모델/점수 v5 baseline + 간단 검증까지
* **프론트**: 오늘 날짜 Top20 + 점수 브레이크다운 + 기본 상세 페이지
* **운영**: 하루 단위 자동 실행 + 로그 분리
* **권한/문서**: 로그인 권한 최소 기능 + 핵심 문서 3개

체크리스트를 기준으로 잡자

* 이번주에 A/B/C 어디까지 묶을지 결정?
* 오늘/내일은 A-1부터 간다. 이렇게 쪼개서 끊어가기 좋을 듯.
